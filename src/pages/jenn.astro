---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="ðŸ‘" description="The Archives">
  <main class="relative min-h-screen px-6 py-12">
    <!-- Background orbs -->
    <div class="absolute top-1/4 left-1/4 w-64 h-64 bg-pink-500/10 rounded-full blur-3xl animate-pulse-slow"></div>
    <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl animate-pulse-slow delay-2000"></div>
    
    <div class="max-width-4xl mx-auto relative z-10">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-5xl md:text-6xl mb-4 font-bold gradient-text glow">
          The Jenn Archives
        </h1>
        <p class="text-xl text-zinc-500">A timeline of legendary moments</p>
        <p class="text-sm text-zinc-600 mt-2"><span id="totalMessages">0</span> messages â€¢ Scroll for more</p>
      </div>

      <!-- Quote Generator - Top Position -->
      <div class="mb-12 p-6 md:p-8 rounded-2xl bg-zinc-900/50 border border-zinc-700 backdrop-blur-sm max-w-3xl mx-auto">
        <h2 class="text-2xl md:text-3xl font-bold mb-4 gradient-text">Random Quote Generator ðŸ’­</h2>
        <button class="quote-btn w-full py-3 px-6 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 rounded-xl font-bold text-base md:text-lg transition-all duration-300 hover:scale-105 active:scale-95 mb-4">
          Generate Random Quote
        </button>
        <div class="quote-display p-4 md:p-6 bg-gradient-to-br from-purple-900/20 to-pink-900/20 border border-purple-600/30 rounded-xl text-center text-base md:text-lg min-h-[80px] flex items-center justify-center transition-opacity duration-200">
          Click to generate a quote!
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="mb-12 max-w-5xl mx-auto">
        <h2 class="text-3xl font-bold mb-6 gradient-text text-center">By The Numbers</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
          
          <div class="stat-card">
            <div class="stat-number">âˆž</div>
            <div class="stat-label">Taco Bell Mentions</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">24/7</div>
            <div class="stat-label">4AM Water Service</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">247</div>
            <div class="stat-label">Nextdoor Posts</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">1</div>
            <div class="stat-label">Perma-Banned Dad</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">420</div>
            <div class="stat-label">Times She Was Right</div>
          </div>

          <div class="stat-card poop-winner">
            <div class="stat-number">110</div>
            <div class="stat-label">Jenn's Poop Talk ðŸ’©</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">60</div>
            <div class="stat-label">James's Poop Talk ðŸ’©</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">1</div>
            <div class="stat-label">Shed Shitters</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">17</div>
            <div class="stat-label">Total Fart References</div>
          </div>

        </div>
      </div>

      <!-- Timeline - Infinite Scroll -->
      <div class="mb-12 max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold mb-8 gradient-text text-center">The Timeline ðŸ’¬</h2>
        
        <div class="timeline" id="timeline">
          <!-- Messages will be loaded here dynamically -->
        </div>

        <div id="loading" class="text-center py-8 text-zinc-500 hidden">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div>
          <p class="mt-2">Loading more memories...</p>
        </div>

        <div id="end-message" class="text-center py-8 text-zinc-600 hidden">
          <p>ðŸ“œ That's all the memories (for now)</p>
          <p class="text-sm text-zinc-700 mt-2">Check back later for more</p>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-center text-zinc-600 text-sm space-y-2 pb-8">
        <p>ðŸ¤– Curated with love (and roasts) by Bender</p>
        <p class="text-zinc-700 text-xs">Scraping 313 messages across 15 months ðŸ“…</p>
      </div>
    </div>
  </main>

  <style>
    .gradient-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .glow {
      filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.5));
    }

    .animate-pulse-slow {
      animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    .delay-2000 {
      animation-delay: 2s;
    }

    .timeline {
      position: relative;
      padding-left: 2rem;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(180deg, transparent, #667eea, #764ba2, transparent);
    }

    .timeline-section {
      margin-bottom: 3rem;
      position: relative;
    }

    .timeline-date {
      font-size: 1.25rem;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 1.5rem;
      margin-left: 1rem;
      position: relative;
    }

    .timeline-date::before {
      content: '';
      position: absolute;
      left: -2.5rem;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: #667eea;
      border-radius: 50%;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
    }

    .message-bubble {
      max-width: 85%;
      margin-bottom: 1rem;
      margin-left: 1rem;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-bubble.received {
      margin-right: auto;
    }

    .message-bubble .message-content {
      background: #3a3a3c;
      color: #fff;
      border-radius: 20px;
      border-bottom-left-radius: 4px;
      padding: 14px 18px;
      margin-bottom: 4px;
      font-size: 1.05rem;
      line-height: 1.4;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .message-time {
      font-size: 0.75rem;
      color: #8e8e93;
      padding: 0 12px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 1rem;
      padding: 1.25rem;
      text-align: center;
      backdrop-filter: blur(10px);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
    }

    .stat-card.poop-winner {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(236, 72, 153, 0.15) 100%);
      border: 2px solid rgba(139, 92, 246, 0.4);
      animation: pulse-glow 2s infinite;
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
      50% { box-shadow: 0 0 30px rgba(236, 72, 153, 0.4); }
    }

    .stat-number {
      font-size: 2rem;
      md:font-size: 2.5rem;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 0.8rem;
      md:font-size: 0.875rem;
      color: #a1a1aa;
      line-height: 1.3;
    }

    .quote-display {
      transition: opacity 0.2s ease;
    }

    @media (max-width: 768px) {
      .message-bubble {
        max-width: 90%;
      }
      
      .timeline {
        padding-left: 1.5rem;
      }
      
      .timeline-date::before {
        left: -2rem;
      }
    }
  </style>

  <script>
    interface Message {
      date: string;
      time: string;
      month: string;
      text: string;
      is_funny: boolean;
    }

    interface JennData {
      total: number;
      months: Record<string, Message[]>;
    }

    let data: JennData | null = null;
    let monthKeys: string[] = [];
    let currentMonthIndex = 0;
    let messagesPerLoad = 15;
    let isLoading = false;

    // Fetch the data
    async function loadData() {
      try {
        const response = await fetch('/jenn-data.json');
        data = await response.json();
        
        if (!data) return;
        
        monthKeys = Object.keys(data.months);
        
        // Update total count
        const totalEl = document.getElementById('totalMessages');
        if (totalEl && data) totalEl.textContent = data.total.toString();
        
        // Load first batch
        loadMoreMessages();
        setupQuoteGenerator();
      } catch (error) {
        console.error('Failed to load data:', error);
      }
    }

    function loadMoreMessages() {
      if (!data || isLoading) return;
      
      isLoading = true;
      const loadingEl = document.getElementById('loading');
      if (loadingEl) loadingEl.classList.remove('hidden');
      
      const timeline = document.getElementById('timeline');
      if (!timeline) return;
      
      let loaded = 0;
      let currentMonth = '';
      
      while (loaded < messagesPerLoad && currentMonthIndex < monthKeys.length) {
        const monthKey = monthKeys[currentMonthIndex];
        const messages = data.months[monthKey];
        
        if (!messages || messages.length === 0) {
          currentMonthIndex++;
          continue;
        }
        
        // Create month section if needed
        if (currentMonth !== monthKey) {
          const section = document.createElement('div');
          section.className = 'timeline-section';
          section.innerHTML = `<div class="timeline-date">${monthKey}</div>`;
          timeline.appendChild(section);
          currentMonth = monthKey;
        }
        
        const currentSection = timeline.lastElementChild;
        
        for (const msg of messages) {
          if (loaded >= messagesPerLoad) break;
          
          const bubble = document.createElement('div');
          bubble.className = 'message-bubble received';
          bubble.innerHTML = `
            <div class="message-content">${escapeHtml(msg.text)}</div>
            <div class="message-time">${msg.time}</div>
          `;
          currentSection?.appendChild(bubble);
          loaded++;
        }
        
        currentMonthIndex++;
      }
      
      if (loadingEl) loadingEl.classList.add('hidden');
      
      if (currentMonthIndex >= monthKeys.length) {
        const endEl = document.getElementById('end-message');
        if (endEl) endEl.classList.remove('hidden');
      }
      
      isLoading = false;
    }

    function setupQuoteGenerator() {
      if (!data) return;
      
      // Collect all messages for quote generator
      const allMessages: string[] = [];
      for (const month of Object.values(data.months)) {
        for (const msg of month) {
          if (msg.is_funny && msg.text.length > 20 && msg.text.length < 200) {
            allMessages.push(msg.text);
          }
        }
      }
      
      const btn = document.querySelector('.quote-btn');
      const display = document.querySelector('.quote-display') as HTMLElement;
      
      btn?.addEventListener('click', () => {
        const quote = allMessages[Math.floor(Math.random() * allMessages.length)];
        
        if (display) {
          display.style.opacity = '0';
          setTimeout(() => {
            display.textContent = `"${quote}"`;
            display.style.opacity = '1';
          }, 200);
        }
      });
    }

    function escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Infinite scroll
    function setupInfiniteScroll() {
      const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && !isLoading && currentMonthIndex < monthKeys.length) {
          loadMoreMessages();
        }
      }, { threshold: 0.1 });
      
      const loadingEl = document.getElementById('loading');
      if (loadingEl) observer.observe(loadingEl);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      setupInfiniteScroll();
    });
  </script>
</BaseLayout>
