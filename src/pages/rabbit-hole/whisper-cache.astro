---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Whisper Cache | üêá" description="Persistent storage. Lossy secrets." favicon="üóùÔ∏è">
  <div class="fixed inset-0 bg-gradient-to-b from-sky-950/15 via-zinc-950 to-zinc-950"></div>

  <header class="fixed top-0 left-0 right-0 z-50 p-6 flex justify-between">
    <a href="/rabbit-hole" class="text-sm text-zinc-600 hover:text-sky-400 transition-colors">‚Üê invalidate</a>
    <span class="text-xs text-zinc-700 font-mono">DEPTH: 5</span>
  </header>

  <main class="relative min-h-screen flex flex-col items-center justify-center px-6 py-24 z-10">
    <div class="max-w-2xl w-full">
      <div class="text-center mb-8">
        <div class="text-5xl mb-4">üóùÔ∏è</div>
        <h1 class="text-3xl font-light text-sky-300/90 mb-2">whisper cache</h1>
        <p class="text-zinc-600 text-xs font-mono">your browser remembers. imperfectly. on purpose.</p>
      </div>

      <div class="border border-zinc-800 rounded bg-zinc-900/40 p-4">
        <div class="flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between mb-3">
          <label for="whisper" class="text-xs font-mono text-zinc-600">add a whisper</label>
          <div class="text-[10px] font-mono text-zinc-700">retention: <span id="retention">??%</span></div>
        </div>

        <div class="flex gap-2">
          <input
            id="whisper"
            class="flex-1 rounded bg-zinc-950/40 border border-zinc-800 px-3 py-2 text-sm text-zinc-300 font-mono focus:outline-none focus:ring-0 focus:border-sky-500"
            placeholder="a secret that can survive corruption‚Ä¶"
          />
          <button id="add" class="px-4 py-2 text-xs border border-zinc-800 rounded hover:border-sky-500 hover:text-sky-400 transition-colors">
            cache
          </button>
        </div>

        <div class="mt-3 flex flex-wrap gap-2">
          <button id="shuffle" class="px-4 py-2 text-xs border border-zinc-800 rounded hover:border-zinc-600 hover:text-zinc-300 transition-colors">
            rehydrate
          </button>
          <button id="purge" class="px-4 py-2 text-xs border border-zinc-800 rounded hover:border-rose-500 hover:text-rose-400 transition-colors">
            purge
          </button>
          <div class="ml-auto text-[10px] font-mono text-zinc-700 self-center" id="status">cache idle</div>
        </div>
      </div>

      <div class="mt-4 space-y-2" id="list"></div>

      <div class="mt-12 flex flex-wrap justify-center gap-4">
        <a href="/rabbit-hole/forgotten-api" class="px-4 py-2 text-xs border border-zinc-800 rounded hover:border-cyan-500 hover:text-cyan-400 transition-colors">forgotten API ‚Üí</a>
        <a href="/rabbit-hole/signal-decay" class="px-4 py-2 text-xs border border-zinc-800 rounded hover:border-amber-500 hover:text-amber-400 transition-colors">signal decay ‚Üí</a>
      </div>

      <p class="mt-10 text-[10px] text-zinc-700 font-mono text-center">
        warning: each time you read a whisper, you reduce its fidelity.
      </p>
    </div>
  </main>
</BaseLayout>

<script>
  type Whisper = {
    id: string;
    text: string;
    createdAt: number;
    reads: number;
    entropy: number; // 0..1
  };

  const KEY = 'urandom_whisper_cache_v1';

  const input = document.getElementById('whisper') as HTMLInputElement | null;
  const addBtn = document.getElementById('add') as HTMLButtonElement | null;
  const shuffleBtn = document.getElementById('shuffle') as HTMLButtonElement | null;
  const purgeBtn = document.getElementById('purge') as HTMLButtonElement | null;

  const list = document.getElementById('list');
  const statusEl = document.getElementById('status');
  const retentionEl = document.getElementById('retention');

  function now() {
    return Date.now();
  }

  function uid() {
    return Math.random().toString(16).slice(2) + '-' + Math.random().toString(16).slice(2);
  }

  function load(): Whisper[] {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw) as Whisper[];
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  }

  function save(ws: Whisper[]) {
    try {
      localStorage.setItem(KEY, JSON.stringify(ws.slice(0, 24)));
    } catch {
      // ignore
    }
  }

  function degrade(s: string, entropy: number) {
    // Replace or drop chars based on entropy
    const chars = s.split('');
    const out: string[] = [];
    for (const ch of chars) {
      const r = Math.random();
      if (r < entropy * 0.06) {
        // drop
        continue;
      }
      if (r < entropy * 0.16) {
        out.push(Math.random() < 0.5 ? '‚ñë' : '¬∑');
        continue;
      }
      out.push(ch);
    }
    const res = out.join('').trim();
    return res.length ? res : '(silence)';
  }

  function retention(ws: Whisper[]) {
    if (!ws.length) return 0;
    const avg = ws.reduce((a, w) => a + (1 - w.entropy), 0) / ws.length;
    return Math.max(0, Math.min(1, avg));
  }

  function setStatus(text: string) {
    statusEl && (statusEl.textContent = text);
  }

  function render() {
    if (!list) return;
    const ws = load().sort((a, b) => b.createdAt - a.createdAt);

    const r = retention(ws);
    retentionEl && (retentionEl.textContent = Math.round(r * 100) + '%');

    list.innerHTML = '';

    if (!ws.length) {
      const empty = document.createElement('div');
      empty.className = 'p-6 text-center text-sm text-zinc-600 border border-zinc-800 rounded bg-zinc-900/20';
      empty.textContent = 'cache miss. there were never any whispers here.';
      list.appendChild(empty);
      return;
    }

    ws.forEach((w) => {
      const card = document.createElement('div');
      card.className = 'p-4 border border-zinc-800 rounded bg-zinc-900/40 hover:bg-zinc-900/70 transition-colors';

      const ageSec = Math.floor((now() - w.createdAt) / 1000);
      const age = ageSec < 60 ? `${ageSec}s` : ageSec < 3600 ? `${Math.floor(ageSec / 60)}m` : `${Math.floor(ageSec / 3600)}h`;

      const preview = degrade(w.text, w.entropy);

      card.innerHTML = `
        <div class="flex justify-between items-start gap-3 mb-2">
          <div class="text-xs font-mono text-sky-400">whisper://${w.id.slice(0, 8)}</div>
          <div class="text-[10px] font-mono text-zinc-700">age: ${age} ¬∑ reads: ${w.reads}</div>
        </div>
        <div class="text-sm text-zinc-300 font-mono leading-relaxed break-words">${escapeHtml(preview)}</div>
        <div class="mt-2 text-[10px] font-mono text-zinc-700">entropy: ${(w.entropy * 100).toFixed(0)}%</div>
      `;

      card.addEventListener('click', () => {
        // Reading increases entropy
        const all = load();
        const idx = all.findIndex((x) => x.id === w.id);
        if (idx >= 0) {
          all[idx].reads += 1;
          all[idx].entropy = Math.min(1, all[idx].entropy + 0.08 + Math.random() * 0.05);
          save(all);
        }
        setStatus('read acknowledged (fidelity reduced)');
        render();
      });

      list.appendChild(card);
    });
  }

  function escapeHtml(s: string) {
    return s.replace(/[&<>"']/g, (ch) => {
      switch (ch) {
        case '&':
          return '&amp;';
        case '<':
          return '&lt;';
        case '>':
          return '&gt;';
        case '"':
          return '&quot;';
        case "'":
          return '&#39;';
        default:
          return ch;
      }
    });
  }

  function decayOnLoad() {
    const ws = load();
    if (!ws.length) return;
    // The cache rots when you look at it.
    ws.forEach((w) => {
      w.entropy = Math.min(1, w.entropy + 0.03 + Math.random() * 0.03);
    });
    save(ws);
  }

  function addWhisper() {
    const text = (input?.value || '').trim();
    if (!text) {
      setStatus('refused: empty whisper');
      return;
    }
    const ws = load();
    ws.unshift({ id: uid(), text, createdAt: now(), reads: 0, entropy: 0.02 + Math.random() * 0.05 });
    save(ws);
    if (input) input.value = '';
    setStatus('cached');
    render();
  }

  addBtn?.addEventListener('click', addWhisper);
  input?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') addWhisper();
  });

  shuffleBtn?.addEventListener('click', () => {
    // "rehydrate" just rerenders with new random decay pattern
    setStatus('rehydrating (this is not recovery)');
    render();
  });

  purgeBtn?.addEventListener('click', () => {
    localStorage.removeItem(KEY);
    setStatus('purged');
    render();
  });

  decayOnLoad();
  render();

  // Drift the retention number for flavor
  setInterval(() => {
    const ws = load();
    const r = retention(ws);
    const wobble = (Math.sin(Date.now() * 0.001) + 1) * 0.5;
    const v = Math.max(0, Math.min(1, r * 0.85 + wobble * 0.15));
    retentionEl && (retentionEl.textContent = Math.round(v * 100) + '%');
  }, 1200);
</script>
