---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { readFile } from 'node:fs/promises';

type IndexEntry = {
  src: string;
  thumb?: string;
  title: string;
  description: string;
  tags: string[];
  model: string;
  date: string;
  sortKey: string;
};

type IndexFile = {
  version: number;
  generatedAt: string;
  images: IndexEntry[];
};

function slug(tag: string) {
  return tag.trim().toLowerCase().replace(/[^a-z0-9-]+/g, '-').replace(/-+/g, '-');
}

export async function getStaticPaths() {
  const indexUrl = new URL('../../../../public/gallery/index.json', import.meta.url);
  const raw = await readFile(indexUrl, 'utf-8');
  const parsed = JSON.parse(raw) as IndexFile;

  const tags = new Set<string>();
  for (const img of parsed.images ?? []) {
    for (const t of img.tags ?? []) {
      if (!t || t === 'ai-art') continue;
      tags.add(t);
    }
  }

  return Array.from(tags).map((tag) => ({
    params: { tag: slug(tag) },
    props: { tag },
  }));
}

const { tag } = Astro.props as { tag: string };

const indexUrl = new URL('../../../../public/gallery/index.json', import.meta.url);
const raw = await readFile(indexUrl, 'utf-8');
const parsed = JSON.parse(raw) as IndexFile;

const images = (parsed.images ?? []).filter((i) => (i.tags ?? []).includes(tag));
const shown = images.slice(0, 60);
---

<BaseLayout title={`#${tag} | Gallery | urandom.io`} description={`Gallery images tagged #${tag}.`} favicon="üè∑Ô∏è">
  <header class="fixed top-0 left-0 right-0 z-50 p-6 bg-zinc-950/80 backdrop-blur-sm">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
      <a href="/gallery" class="text-sm text-zinc-600 hover:text-purple-400 transition-colors">‚Üê gallery</a>
      <span class="text-xs text-zinc-700 font-mono">tag: <span class="text-purple-400">#{tag}</span> ¬∑ frames: {images.length}</span>
    </div>
  </header>

  <main class="min-h-screen px-6 pt-24 pb-12">
    <div class="max-w-6xl mx-auto">
      <div class="text-center mb-10">
        <h1 class="text-3xl font-light">
          <span class="gradient-text glow">#{tag}</span>
        </h1>
        <p class="text-zinc-600 text-sm mt-2">A slice of the feed for this tag.</p>
      </div>

      <div class="flex flex-col gap-8 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-8 mb-16">
        {shown.map((image) => (
          <article class="group relative" data-tags={image.tags.join(' ')} data-src={image.src}>
            <div class="relative overflow-hidden rounded-lg bg-zinc-900 border border-zinc-800 hover:border-purple-500/50 transition-all duration-500">
              <a href={`/gallery?tag=${encodeURIComponent(tag)}`} class="block aspect-square w-full overflow-hidden">
                <img
                  src={image.thumb ?? image.src}
                  alt={image.title}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"
                  loading="lazy"
                  draggable="false"
                />
              </a>
              <div class="absolute inset-0 bg-gradient-to-t from-zinc-950 via-zinc-950/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4 pointer-events-none">
                <h3 class="text-lg text-zinc-100 mb-1">{image.title}</h3>
                <p class="text-xs text-zinc-400 mb-2">{image.description}</p>
                <div class="flex items-center gap-2 text-xs text-zinc-600">
                  <span class="font-mono">{image.date}</span>
                  <span>¬∑</span>
                  <span class="text-purple-400">{image.model}</span>
                </div>
              </div>
            </div>

            <div class="flex flex-wrap gap-2 mt-3">
              {image.tags.map((t) => (
                <a href={`/gallery?tag=${encodeURIComponent(t)}`} class="text-xs text-zinc-700 hover:text-purple-400 transition-colors">#{t}</a>
              ))}
            </div>
          </article>
        ))}
      </div>

      <div class="text-center">
        <a href={`/gallery?tag=${encodeURIComponent(tag)}`} class="px-4 py-2 text-xs border border-zinc-800 rounded hover:border-purple-500 hover:text-purple-300 transition-colors">
          open full feed ‚Üí
        </a>
      </div>
    </div>
  </main>
</BaseLayout>
