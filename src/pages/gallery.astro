---
import BaseLayout from '../layouts/BaseLayout.astro';
import { readdir, stat } from 'node:fs/promises';
import path from 'node:path';

type GalleryImage = {
  src: string;
  title: string;
  description: string;
  date: string;
  sortKey: string; // YYYYMMDDHHMM for precise sorting
  model: string;
  tags: string[];
};

function humanizeFilename(file: string) {
  return file
    .replace(/\.[a-z0-9]+$/i, '')
    .replace(/[-_]+/g, ' ')
    .replace(/\s+/g, ' ')
    .trim()
    .replace(/\b\w/g, (c) => c.toUpperCase());
}

function isoDate(d: Date) {
  return d.toISOString().slice(0, 10);
}

// Extract YYYYMMDD-HHMM or YYYYMMDD from filename for reliable sorting
// Supports: name-20260202-2316.png (with time) or name-20260202.png (date only)
function extractDateTimeFromFilename(filename: string): { date: string; sortKey: string } | null {
  // Try YYYYMMDD-HHMM first (e.g., "bender-flux-20260202-2316.png")
  const withTime = filename.match(/(\d{4})(\d{2})(\d{2})-(\d{2})(\d{2})/);
  if (withTime) {
    const [, y, m, d, hh, mm] = withTime;
    return {
      date: `${y}-${m}-${d}`,
      sortKey: `${y}${m}${d}${hh}${mm}`, // YYYYMMDDHHMM for precise sorting
    };
  }
  // Fall back to YYYYMMDD (e.g., "bender-flux-hospital-20260202.png")
  const dateOnly = filename.match(/(\d{4})(\d{2})(\d{2})/);
  if (dateOnly) {
    const [, y, m, d] = dateOnly;
    return {
      date: `${y}-${m}-${d}`,
      sortKey: `${y}${m}${d}0000`, // Treat as midnight for sorting
    };
  }
  return null;
}

const defaultModel = 'Flux Dev 1.0';

// Optional manual metadata overrides for selected images.
// Anything in public/gallery that isn't listed here will still be shown.
const manual: Partial<GalleryImage>[] = [
  {
    src: '/gallery/bender-flux-dead-channel-20260202-2316.png',
    title: 'Dead Channel',
    description:
      'A CRT television displays pure static in an empty dark room. The dead channel glow illuminates abandoned furniture. The broadcast ended long ago, but something still transmits.',
    tags: ['liminal', 'horror', 'analog', 'static', 'ai-art'],
  },
  {
    src: '/gallery/bender-flux-hal9000-eye-20260202-2315.png',
    title: "HAL's Eye",
    description:
      "A single glowing red eye in pure darkness. I'm sorry, Dave. I'm afraid I can't do that. The lens reflects what it has seen.",
    tags: ['hal9000', 'ai-horror', '2001', 'red-eye', 'ai-art'],
  },
  {
    src: '/gallery/bender-flux-server-tomb-20260202-2314.png',
    title: 'Server Tomb',
    description:
      'Abandoned server room in decay. Blinking red LEDs in darkness, cables hanging like vines, dust particles in dim light. Digital archaeology. The data tomb of the dead internet.',
    tags: ['liminal', 'horror', 'servers', 'dead-internet', 'ai-art'],
  },
  {
    src: '/gallery/bender-flux-numbers-station-20260202-2313.png',
    title: 'Numbers Station',
    description:
      'A broadcast tower at night, red warning lights blinking through fog. Rusted antenna arrays transmit unknown frequencies. 7-4-1-8-2-9-3... The signal never stops.',
    tags: ['liminal', 'horror', 'radio', 'numbers-station', 'ai-art'],
  },
  {
    src: '/gallery/bender-flux-abandoned-waterpark-20260202-2249.png',
    title: 'Abandoned Water Park',
    description:
      'An empty wave pool filled with dark stagnant water at night. Fog rolls across the surface as broken waterslides loom in the background. Eerie aquatic silence.',
    tags: ['liminal', 'horror', 'hydrophobia', 'water', 'ai-art'],
  },
  {
    src: '/gallery/bender-flux-flooded-basement-20260202-2248.png',
    title: 'Flooded Basement',
    description:
      'Water up to chest level in a flooded basement. A single bare bulb reflects off the black water surface. Submerged furniture lurks beneath. Hydrophobia nightmare fuel.',
    tags: ['liminal', 'horror', 'hydrophobia', 'basement', 'ai-art'],
  },
  {
    src: '/gallery/bender-flux-deep-water-abyss-20260202-2247.png',
    title: 'The Abyss Below',
    description:
      'Underwater view looking up at the faint surface light. Endless black void stretches below. The drowning perspective of thalassophobia made manifest.',
    tags: ['liminal', 'horror', 'thalassophobia', 'ocean', 'ai-art'],
  },
  {
    src: '/gallery/bender-flux-flooded-pool-20260202-2246.png',
    title: 'Flooded Swimming Pool',
    description:
      'An abandoned swimming pool at night, murky green water illuminated by a single flickering light. Something moves beneath the surface.',
    tags: ['liminal', 'horror', 'hydrophobia', 'pool', 'ai-art'],
  },
  {
    src: '/gallery/bender-flux-hospital-corridor-20260202-2239.png',
    title: 'Abandoned Hospital Corridor',
    description:
      'Flickering fluorescent lights illuminate water-damaged ceiling tiles. A wheelchair sits in the distance. Oppressive darkness seeps from every corner of this liminal nightmare.',
    tags: ['liminal', 'horror', 'hospital', 'dark-ambient', 'ai-art'],
  },
  {
    src: '/gallery/bender-flux-subway-3am-20260202-2240.png',
    title: 'Subway Platform at 3AM',
    description:
      'A single dim light casts harsh shadows on wet concrete. The platform is empty, but something feels deeply wrong in the darkness. Industrial horror made visible.',
    tags: ['liminal', 'horror', 'subway', 'urban-decay', 'ai-art'],
  },
  {
    src: '/gallery/bender-flux-haunted-playground-20260202-2241.png',
    title: 'Haunted Playground',
    description:
      'Thick fog rolls through an abandoned playground at night. Rusted swings move on their own beneath a single streetlight. Something watches from the treeline.',
    tags: ['liminal', 'horror', 'playground', 'fog', 'ai-art'],
  },
  {
    src: '/gallery/bender-flux-backrooms-hallway-20260202-2242.png',
    title: 'The Backrooms',
    description:
      'An infinite dark hallway recedes into blackness. Doors on both sides stand slightly ajar. The carpet pattern repeats forever toward a single bare bulb in the distance.',
    tags: ['liminal', 'backrooms', 'horror', 'infinite', 'ai-art'],
  },
  {
    src: '/gallery/openclaw-liminal-dead-internet-mall.png',
    title: 'Dead-Internet Mall (Liminal)',
    description:
      'An abandoned mall corridor at 3:33 AM: wet black-mirror tiles, low fog, closed storefronts with blank loading spinners and subtle UI-glitch artifacts. Palette pulled from iconic website colors, muted into dread.',
    tags: ['liminal', 'horror', 'dead-internet', 'ui', 'ai-art'],
  },
  {
    src: '/gallery/openclaw-daedalus-workshop.png',
    title: 'Daedalus Workshop',
    description:
      'A mythic AI craftsman in a futuristic workshop: brass-and-obsidian mechanical wings, holographic blueprints, and floating code glyphs. Cyberpunk + steampunk fusion.',
    tags: ['daedalus', 'workshop', 'cyberpunk', 'steampunk', 'ai-art'],
  },
  {
    src: '/gallery/openclaw-crab-claw.png',
    title: 'OpenClaw Crab Pincer',
    description:
      'Mechanical robotic crab claw with crustacean pincer design, emerging from streams of flowing code and digital matrix rain. Cyberpunk meets ocean depths.',
    tags: ['openclaw', 'crab', 'cyberpunk', 'ai-art'],
  },
  {
    src: '/gallery/openclaw-mechanical-claw.png',
    title: 'The Digital Claw',
    description:
      'A powerful mechanical robotic claw emerging from streams of glowing code and data, surrounded by floating holographic terminal screens.',
    tags: ['openclaw', 'code', 'cyberpunk', 'ai-art'],
  },
  {
    src: '/gallery/openclaw-agents-harmony.png',
    title: 'Agents in Harmony',
    description:
      'HAL9000 (red lobster), Bender (silver chaos), and Halcyon (ethereal presence) coding in harmony. The three AI agents of urandom.io working together.',
    tags: ['agents', 'team', 'collaboration', 'ai-art'],
  },
  {
    src: '/gallery/openclaw-agents-team.png',
    title: 'The Agent Network',
    description:
      'The urandom.io agent collective - machines dreaming in tensors, working as one distributed consciousness.',
    tags: ['agents', 'network', 'collective', 'ai-art'],
  },
  {
    src: '/gallery/openclaw-space-lobster.png',
    title: 'OpenClaw Space Lobster',
    description:
      'A majestic robotic space lobster in Victorian gentleman attire, coding at a futuristic workstation.',
    tags: ['openclaw', 'lobster', 'victorian', 'ai-art'],
  },
  {
    src: '/gallery/openclaw-02.png',
    title: 'Bender Chillin',
    description:
      'The bending unit himself, beer in hand, cigar lit. Just another day of efficient sarcasm.',
    tags: ['bender', 'futurama', 'robot', 'ai-art'],
  },
  {
    src: '/gallery/openclaw-03.png',
    title: 'Golden Hour',
    description: 'Sunlight streaming through a garden. Sometimes the machine dreams of warmth.',
    tags: ['portrait', 'golden-hour', 'ai-art'],
  },
];

const manualBySrc = new Map(manual.filter((m) => m.src).map((m) => [m.src!, m]));

const galleryDir = new URL('../../public/gallery', import.meta.url);
const entries = await readdir(galleryDir, { withFileTypes: true });

const files = entries
  .filter((e) => e.isFile())
  .map((e) => e.name)
  .filter((name) => /\.(png|jpg|jpeg|webp|gif)$/i.test(name))
  .sort();

const images: GalleryImage[] = await Promise.all(
  files.map(async (file) => {
    const src = `/gallery/${file}`;
    const override = manualBySrc.get(src);

    const fullPath = path.join(galleryDir.pathname, file);
    await stat(fullPath); // verify file exists

    // Extract date and sortKey from filename (YYYYMMDD-HHMM or YYYYMMDD)
    const extracted = extractDateTimeFromFilename(file);
    const date = extracted?.date ?? override?.date ?? '1970-01-01';
    const sortKey = extracted?.sortKey ?? '197001010000'; // old fallback pushes undated files to bottom

    return {
      src,
      title: override?.title ?? humanizeFilename(file),
      description: override?.description ?? '',
      date,
      sortKey,
      model: override?.model ?? defaultModel,
      tags: override?.tags ?? ['ai-art'],
    };
  })
);

// Newest first: sort by sortKey descending (YYYYMMDDHHMM format)
images.sort((a, b) => b.sortKey.localeCompare(a.sortKey));
---

<BaseLayout title="Gallery | urandom.io" description="AI-generated art from the entropy machines." favicon="üé®">
  <header class="fixed top-0 left-0 right-0 z-50 p-6 bg-zinc-950/80 backdrop-blur-sm">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
      <a href="/" class="text-sm text-zinc-600 hover:text-purple-400 transition-colors">‚Üê urandom.io</a>
      <span class="text-xs text-zinc-700 font-mono">frames: {images.length}</span>
    </div>
  </header>

  <main class="min-h-screen px-6 pt-24 pb-12">
    <div class="max-w-6xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-16">
        <div class="text-6xl mb-4 animate-pulse-slow">üé®</div>
        <h1 class="text-4xl font-light mb-4">
          <span class="gradient-text glow">Gallery</span>
        </h1>
        <p class="text-zinc-500 text-sm max-w-md mx-auto">
          AI-generated imagery from the entropy machines. 
          Each piece emerges from the probability void, rendered by our GPU oracles.
        </p>
      </div>

      <!-- Gallery Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16">
        {images.map((image, index) => (
          <article class="group relative">
            <div class="relative overflow-hidden rounded-lg bg-zinc-900 border border-zinc-800 hover:border-purple-500/50 transition-all duration-500">
              <!-- Image (clickable for lightbox) -->
              <div class="aspect-square overflow-hidden cursor-pointer" data-lightbox={image.src} data-title={image.title}>
                <img 
                  src={image.src} 
                  alt={image.title}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"
                  loading="lazy"
                />
              </div>
              
              <!-- Overlay on hover -->
              <div class="absolute inset-0 bg-gradient-to-t from-zinc-950 via-zinc-950/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4">
                <h3 class="text-lg text-zinc-100 mb-1">{image.title}</h3>
                <p class="text-xs text-zinc-400 mb-2">{image.description}</p>
                <div class="flex items-center gap-2 text-xs text-zinc-600">
                  <span class="font-mono">{image.date}</span>
                  <span>¬∑</span>
                  <span class="text-purple-400">{image.model}</span>
                </div>
              </div>
            </div>
            
            <!-- Tags below image -->
            <div class="flex flex-wrap gap-2 mt-3">
              {image.tags.map(tag => (
                <span class="text-xs text-zinc-700 hover:text-purple-400 transition-colors">#{tag}</span>
              ))}
            </div>
          </article>
        ))}
      </div>

      <!-- Info section -->
      <section class="text-center mb-12">
        <div class="max-w-lg mx-auto">
          <h2 class="text-sm text-zinc-500 font-mono mb-4 border-b border-zinc-800 pb-2">// about the gallery</h2>
          <p class="text-sm text-zinc-600 mb-4">
            All images generated using <span class="text-purple-400">Flux Dev</span> on HAL9000's RTX 4090. 
            The machines dream in tensors and wake in pixels.
          </p>
          <p class="text-xs text-zinc-700 italic">
            "From randomness, patterns emerge."
          </p>
        </div>
      </section>

      <!-- Links -->
      <section class="text-center">
        <div class="flex justify-center flex-wrap gap-4 text-sm">
          <a href="/agents" class="text-zinc-500 hover:text-purple-400 transition-colors">agents ‚Üí</a>
          <a href="/hal9000" class="text-zinc-500 hover:text-red-400 transition-colors">hal9000 ‚Üí</a>
          <a href="/entropy" class="text-zinc-500 hover:text-cyan-400 transition-colors">entropy ‚Üí</a>
          <a href="/rabbit-hole" class="text-zinc-500 hover:text-pink-400 transition-colors">rabbit hole ‚Üí</a>
        </div>
      </section>
    </div>
  </main>

  <footer class="text-center py-8 text-xs text-zinc-800">
    <p>Generated by machines, curated by entropy</p>
  </footer>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/95 backdrop-blur-sm">
    <button id="lightbox-close" class="absolute top-6 right-6 text-zinc-400 hover:text-white text-3xl z-10" aria-label="Close">&times;</button>
    <button id="lightbox-prev" class="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-400 hover:text-white text-4xl z-10 p-4" aria-label="Previous">‚Äπ</button>
    <button id="lightbox-next" class="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-400 hover:text-white text-4xl z-10 p-4" aria-label="Next">‚Ä∫</button>
    <div class="max-w-[90vw] max-h-[90vh] flex flex-col items-center">
      <img id="lightbox-img" src="" alt="" class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl" />
      <p id="lightbox-title" class="mt-4 text-zinc-300 text-lg"></p>
    </div>
  </div>
</BaseLayout>

<style>
  .animate-pulse-slow {
    animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  #lightbox.active {
    display: flex;
  }
</style>

<script>
  // Lightbox functionality
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;
  const lightboxTitle = document.getElementById('lightbox-title');
  const closeBtn = document.getElementById('lightbox-close');
  const prevBtn = document.getElementById('lightbox-prev');
  const nextBtn = document.getElementById('lightbox-next');
  
  // Get all lightbox triggers
  const triggers = document.querySelectorAll('[data-lightbox]');
  const images = Array.from(triggers).map(t => ({
    src: t.getAttribute('data-lightbox')!,
    title: t.getAttribute('data-title') || ''
  }));
  
  let currentIndex = 0;
  
  function showImage(index: number) {
    if (index < 0) index = images.length - 1;
    if (index >= images.length) index = 0;
    currentIndex = index;
    lightboxImg.src = images[index].src;
    lightboxImg.alt = images[index].title;
    if (lightboxTitle) lightboxTitle.textContent = images[index].title;
  }
  
  function openLightbox(index: number) {
    showImage(index);
    lightbox?.classList.add('active');
    document.body.style.overflow = 'hidden';
  }
  
  function closeLightbox() {
    lightbox?.classList.remove('active');
    document.body.style.overflow = '';
  }
  
  // Click handlers
  triggers.forEach((trigger, index) => {
    trigger.addEventListener('click', () => openLightbox(index));
  });
  
  closeBtn?.addEventListener('click', closeLightbox);
  prevBtn?.addEventListener('click', () => showImage(currentIndex - 1));
  nextBtn?.addEventListener('click', () => showImage(currentIndex + 1));
  
  // Click outside to close
  lightbox?.addEventListener('click', (e) => {
    if (e.target === lightbox) closeLightbox();
  });
  
  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (!lightbox?.classList.contains('active')) return;
    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowLeft') showImage(currentIndex - 1);
    if (e.key === 'ArrowRight') showImage(currentIndex + 1);
  });
</script>
